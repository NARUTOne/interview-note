# P5

> React Hooks

**âš¡é¢˜ç›®**:

â“ ç®€è¿°React Hooksï¼Ÿ

## ä¼˜è§£ ğŸ”¥

Hook æ˜¯ React 16.8 çš„æ–°å¢ç‰¹æ€§ã€‚å®ƒå¯ä»¥è®©ä½ åœ¨ä¸ç¼–å†™ class çš„æƒ…å†µä¸‹ä½¿ç”¨ state ä»¥åŠå…¶ä»–çš„ React ç‰¹æ€§ã€‚

### useState

> classç»„ä»¶ä¸­çš„ç±»ä¼¼ `this.setState`

```js
const [state, setState] = useState(initialState);

setState(1) // æ›´æ–°
setState(prev => prev + 1) // å‡½æ•°å¼æ›´æ–°
setState(prev => {...prev, ...updateV}) // åˆå¹¶æ›´æ–°å¯¹è±¡

// åˆå§‹åŒ–å¤æ‚
const [state, setState] = useState(() => {
  const initialState = someExpensiveComputation(props);
  return initialState;
});

```

- è¿”å›ä¸€ä¸ª stateï¼Œä»¥åŠæ›´æ–° state çš„å‡½æ•°ã€‚
- åœ¨åˆå§‹æ¸²æŸ“æœŸé—´ï¼Œè¿”å›çš„çŠ¶æ€ (state) ä¸ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•° (initialState) å€¼ç›¸åŒã€‚
- ä¸ class ç»„ä»¶ä¸­çš„ setState æ–¹æ³•ä¸åŒï¼ŒuseState ä¸ä¼šè‡ªåŠ¨åˆå¹¶æ›´æ–°å¯¹è±¡ã€‚å¯ä»¥ç”¨å‡½æ•°å¼çš„ setState ç»“åˆå±•å¼€è¿ç®—ç¬¦æ¥è¾¾åˆ°åˆå¹¶æ›´æ–°å¯¹è±¡çš„æ•ˆæœã€‚
- initialState å‚æ•°åªä¼šåœ¨ç»„ä»¶çš„åˆå§‹æ¸²æŸ“ä¸­èµ·ä½œç”¨ï¼Œåç»­æ¸²æŸ“æ—¶ä¼šè¢«å¿½ç•¥ã€‚
- æ¯æ¬¡setState éƒ½å°†æ›´æ–°è¯¥ç»„ä»¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒReact å¯èƒ½ä»éœ€è¦åœ¨è·³è¿‡æ¸²æŸ“å‰æ¸²æŸ“è¯¥ç»„ä»¶ã€‚ä¸è¿‡ç”±äº React ä¸ä¼šå¯¹ç»„ä»¶æ ‘çš„â€œæ·±å±‚â€èŠ‚ç‚¹è¿›è¡Œä¸å¿…è¦çš„æ¸²æŸ“ï¼Œæ‰€ä»¥å¤§å¯ä¸å¿…æ‹…å¿ƒ
- å¦‚æœä½ åœ¨æ¸²æŸ“æœŸé—´æ‰§è¡Œäº†é«˜å¼€é”€çš„è®¡ç®—ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ useMemo æ¥è¿›è¡Œä¼˜åŒ–ã€‚

### useEffect

> åœ¨å‡½æ•°ç»„ä»¶é‡Œé¢ä½¿ç”¨ classçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°çš„åˆä½“

è¯¥ Hook æ¥æ”¶ä¸€ä¸ªåŒ…å«å‘½ä»¤å¼ã€ä¸”å¯èƒ½æœ‰å‰¯ä½œç”¨ä»£ç çš„å‡½æ•°ã€‚

```js
// æ¯æ¬¡æ¸²æŸ“æ‰§è¡Œ
useEffect(() => {})

// æ‰§è¡Œä¸€æ¬¡
useEffect(() => {

  // ç»„ä»¶å¸è½½æ‰§è¡Œ
  return () => {}
}, []);

// ä¾èµ–açš„å˜åŒ–è¿›è¡Œæ‰§è¡Œ, æ”¯æŒå¤šä¸ªä¾èµ–
useEffect(() => {
  setState(a)
}, [a])
```

- `eslint-plugin-react-hooks` è¿›è¡Œä¾èµ–æ£€æŸ¥
- useEffectä¸èƒ½è¢«åˆ¤æ–­åŒ…è£¹
- useEffect é‡Œé¢ä½¿ç”¨åˆ°çš„stateçš„å€¼, å›ºå®šåœ¨äº†useEffectå†…éƒ¨ï¼Œ ä¸ä¼šè¢«æ”¹å˜ï¼Œé™¤éuseEffectåˆ·æ–°ï¼Œé‡æ–°å›ºå®šstateçš„å€¼ ï¼ˆå‡½æ•°ç»„ä»¶ï¼Œæ¯æ¬¡æ‰§è¡Œæ¸²æŸ“éƒ½æ˜¯æ–°çš„ä¸Šä¸‹æ–‡ç¯å¢ƒã€é—­åŒ…ã€‘ï¼‰
- useEffectä¸èƒ½è¢«æ‰“æ–­

### useRef

> ç±»ä¼¼äºclassä¸­çš„refå’Œthis[param]é™æ€å±æ€§

```js
const refContainer = useRef(initialValue);
```

- useRef è¿”å›ä¸€ä¸ªå¯å˜çš„ ref å¯¹è±¡ï¼Œå…¶ `.current` å±æ€§è¢«åˆå§‹åŒ–ä¸ºä¼ å…¥çš„å‚æ•°ï¼ˆinitialValueï¼‰ã€‚è¿”å›çš„ ref å¯¹è±¡åœ¨ç»„ä»¶çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…ä¿æŒä¸å˜, æ‰€ä»¥è¦æ³¨æ„æŒ‰éœ€æ›´æ–°èµ‹å€¼
- useRef æ¯” ref å±æ€§æ›´æœ‰ç”¨ã€‚å®ƒå¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä¿å­˜ä»»ä½•å¯å˜å€¼
- å˜æ›´ `.current` å±æ€§ä¸ä¼šå¼•å‘ç»„ä»¶é‡æ–°æ¸²æŸ“
- å›è°ƒref, åœ¨ React ç»‘å®šæˆ–è§£ç»‘ DOM èŠ‚ç‚¹çš„ ref æ—¶è¿è¡ŒæŸäº›ä»£ç 
- ä¿æŒuseEffectå†…éƒ¨æ‰€ä½¿ç”¨çš„å€¼çš„ç¨³å®š

```js
function MeasureExample() {
  const [height, setHeight] = useState(0);

  const measuredRef = useCallback(node => {
    if (node !== null) {
      setHeight(node.getBoundingClientRect().height);
    }
  }, []);

  return (
    <>
      <h1 ref={measuredRef}>Hello, world</h1>
      <h2>The above header is {Math.round(height)}px tall</h2>
    </>
  );
}
```

### useMemo

> memo çš„å«ä¹‰ç±»ä¼¼ï¼šclassç»„ä»¶é‡Œé¢çš„`PureComponent`ï¼Œ æš‚å­˜ä¸Šä¸€æ¬¡è®¡ç®—å€¼ï¼Œé¿å…æ¯æ¬¡æ¸²æŸ“å¯¼è‡´å˜é‡åœ°å€æ›´æ”¹ï¼Œè§¦å‘ç›¸å…³ç»„ä»¶å‘ç”Ÿæ¸²æŸ“

æŠŠâ€œåˆ›å»ºâ€å‡½æ•°å’Œä¾èµ–é¡¹æ•°ç»„ä½œä¸ºå‚æ•°ä¼ å…¥ useMemoï¼Œå®ƒä»…ä¼šåœ¨æŸä¸ªä¾èµ–é¡¹æ”¹å˜æ—¶æ‰é‡æ–°è®¡ç®— memoized å€¼ã€‚è¿™ç§ä¼˜åŒ–æœ‰åŠ©äºé¿å…åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½è¿›è¡Œé«˜å¼€é”€çš„è®¡ç®—ã€‚

```js
const memoizedValue = useMemo(() => computeExpensiveValue(a, b), [a, b]);
```

- å¦‚æœæ²¡æœ‰æä¾›ä¾èµ–é¡¹æ•°ç»„ï¼ŒuseMemo åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½ä¼šè®¡ç®—æ–°çš„å€¼ã€‚
- å…ˆç¼–å†™åœ¨æ²¡æœ‰ useMemo çš„æƒ…å†µä¸‹ä¹Ÿå¯ä»¥æ‰§è¡Œçš„ä»£ç  â€”â€” ä¹‹åå†åœ¨ä½ çš„ä»£ç ä¸­æ·»åŠ  useMemoï¼Œä»¥è¾¾åˆ°ä¼˜åŒ–æ€§èƒ½çš„ç›®çš„ã€‚(å°†æ¥ï¼ŒReact å¯èƒ½ä¼šé€‰æ‹©â€œé—å¿˜â€ä»¥å‰çš„ä¸€äº› memoized å€¼ï¼Œå¹¶åœ¨ä¸‹æ¬¡æ¸²æŸ“æ—¶é‡æ–°è®¡ç®—å®ƒä»¬)
- memoæ˜¯æµ…æ¯”è¾ƒï¼Œæ„æ€æ˜¯ï¼Œå¯¹è±¡åªæ¯”è¾ƒå†…å­˜åœ°å€ï¼Œåªè¦ä½ å†…å­˜åœ°å€æ²¡å˜ï¼Œç®¡ä½ å¯¹è±¡é‡Œé¢çš„å€¼åƒå˜ä¸‡åŒ–éƒ½ä¸ä¼šè§¦å‘render
- å€¼ç¼“å­˜ï¼Œæš‚å­˜èƒ½åŠ›

### useCallback

> å‡½æ•°ç¼“å­˜æš‚å­˜ï¼Œå…¶ä»–ç±»ä¼¼useMemoã€‚`useCallback(fn, deps)` ç›¸å½“äº `useMemo(() => fn, deps)`

```js
const memoizedCallback = useCallback(
  () => {
    doSomething(a, b);
  },
  [a, b],
);
```

### useReducer

> ç®€æ˜“çš„ `reducer` æ¨¡å¼; useState å¤„ç†å¤šå€¼çš„æ›¿ä»£æ–¹æ¡ˆï¼Œç‰¹æ€§ç±»ä¼¼useState

```js
const initialState = {count: 0};

function reducer(state, action) {
  switch (action.type) {
    case 'increment':
      return {count: state.count + 1};
    case 'decrement':
      return {count: state.count - 1};
    default:
      throw new Error();
  }
}

function Counter() {
  const [state, dispatch] = useReducer(reducer, initialState);
  return (
    <>
      Count: {state.count}
      <button onClick={() => dispatch({type: 'decrement'})}>-</button>
      <button onClick={() => dispatch({type: 'increment'})}>+</button>
    </>
  );
}
```

### useContext

> useContext å°±æ˜¯ class é‡Œé¢çš„ é‚£ä¸ª context;

æ¥æ”¶ä¸€ä¸ª context å¯¹è±¡ï¼ˆ`React.createContext` çš„è¿”å›å€¼ï¼‰å¹¶è¿”å›è¯¥ context çš„å½“å‰å€¼ã€‚å½“å‰çš„ context å€¼ç”±ä¸Šå±‚ç»„ä»¶ä¸­è·ç¦»å½“å‰ç»„ä»¶æœ€è¿‘çš„ `<MyContext.Provider>` çš„ value prop å†³å®šã€‚

å½“ç»„ä»¶ä¸Šå±‚æœ€è¿‘çš„ `<MyContext.Provider>` æ›´æ–°æ—¶ï¼Œè¯¥ Hook ä¼šè§¦å‘é‡æ¸²æŸ“ï¼Œå¹¶ä½¿ç”¨æœ€æ–°ä¼ é€’ç»™ `MyContext provider` çš„ `context value` å€¼ã€‚
å³ä½¿ç¥–å…ˆä½¿ç”¨ `React.memo` æˆ– `shouldComponentUpdate`ï¼Œä¹Ÿä¼šåœ¨ç»„ä»¶æœ¬èº«ä½¿ç”¨ useContext æ—¶é‡æ–°æ¸²æŸ“ã€‚

```js
// ç›¸å½“äº <MyContext.Consumer>
const value = useContext(MyContext);
```

- useContext çš„å‚æ•°å¿…é¡»æ˜¯ context å¯¹è±¡æœ¬èº«
- `useContext(MyContext)` åªæ˜¯è®©ä½ èƒ½å¤Ÿè¯»å– context çš„å€¼ä»¥åŠè®¢é˜… context çš„å˜åŒ–ã€‚ä½ ä»ç„¶éœ€è¦åœ¨ä¸Šå±‚ç»„ä»¶æ ‘ä¸­ä½¿ç”¨ `<MyContext.Provider>` æ¥ä¸ºä¸‹å±‚ç»„ä»¶æä¾› contextã€‚

### useImperativeHandle

> å‡½æ•°å¼ç»„ä»¶å‘çˆ¶ç»„ä»¶æš´éœ²å®ä¾‹å€¼åŠæ–¹æ³•

```js
useImperativeHandle(ref, createHandle, [deps])

// eg
function FancyInput(props, ref) {
  const inputRef = useRef();
  useImperativeHandle(ref, () => ({
    focus: () => {
      inputRef.current.focus();
    }
  }));
  return <input ref={inputRef} />;
}
FancyInput = forwardRef(FancyInput);
```

- useImperativeHandle åº”å½“ä¸ forwardRef ä¸€èµ·ä½¿ç”¨

### useLayoutEffect

> å…¶å‡½æ•°ç­¾åä¸ useEffect ç›¸åŒï¼Œä½†å®ƒä¼šåœ¨æ‰€æœ‰çš„ `DOM å˜æ›´ä¹‹å` åŒæ­¥è°ƒç”¨ effect

- è¯»å– DOM å¸ƒå±€å¹¶åŒæ­¥è§¦å‘é‡æ¸²
- æœåŠ¡ç«¯æ¸²æŸ“ï¼Œè¯·è®°ä½ï¼Œæ— è®º useLayoutEffect è¿˜æ˜¯ useEffect éƒ½æ— æ³•åœ¨ Javascript ä»£ç åŠ è½½å®Œæˆä¹‹å‰æ‰§è¡Œ

### useDebugValue

> ç”¨äºåœ¨ React å¼€å‘è€…å·¥å…·ä¸­æ˜¾ç¤ºè‡ªå®šä¹‰ hook çš„æ ‡ç­¾

```js
// ä¸€ä¸ªè¿”å› Date å€¼çš„è‡ªå®šä¹‰ Hook å¯ä»¥é€šè¿‡æ ¼å¼åŒ–å‡½æ•°æ¥é¿å…ä¸å¿…è¦çš„ toDateString å‡½æ•°è°ƒç”¨ï¼š
useDebugValue(date, date => date.toDateString());

// eg
function useFriendStatus(friendID) {
  const [isOnline, setIsOnline] = useState(null);

  // ...

  // åœ¨å¼€å‘è€…å·¥å…·ä¸­çš„è¿™ä¸ª Hook æ—è¾¹æ˜¾ç¤ºæ ‡ç­¾
  // e.g. "FriendStatus: Online"
  useDebugValue(isOnline ? 'Online' : 'Offline');

  return isOnline;
}
```

æˆ‘ä»¬ä¸æ¨èä½ å‘æ¯ä¸ªè‡ªå®šä¹‰ Hook æ·»åŠ  debug å€¼ã€‚å½“å®ƒä½œä¸ºå…±äº«åº“çš„ä¸€éƒ¨åˆ†æ—¶æ‰æœ€æœ‰ä»·å€¼ã€‚

- ç¬¬äºŒä¸ªå‚æ•°ã€‚è¯¥å‡½æ•°åªæœ‰åœ¨ Hook è¢«æ£€æŸ¥æ—¶æ‰ä¼šè¢«è°ƒç”¨ã€‚å®ƒæ¥å— debug å€¼ä½œä¸ºå‚æ•°ï¼Œå¹¶ä¸”ä¼šè¿”å›ä¸€ä¸ªæ ¼å¼åŒ–çš„æ˜¾ç¤ºå€¼ã€‚
