# P1

> React/Vue åˆ—è¡¨ç»„ä»¶ä¸­key

**âš¡é¢˜ç›®**:

â“ key åœ¨ç»„ä»¶æ¸²æŸ“ä¸­ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

## ä¼˜è§£ ğŸ”¥

vueå’Œreactéƒ½æ˜¯é‡‡ç”¨diffç®—æ³•æ¥å¯¹æ¯”æ–°æ—§è™šæ‹ŸèŠ‚ç‚¹ï¼Œä»è€Œæ›´æ–°èŠ‚ç‚¹ã€‚
vueé‡‡ç”¨ä¾èµ–æ”¶é›†è¿½è¸ªï¼Œå¯ä»¥æ›´åŠ ç»†ç²’åº¦çš„æ›´æ–°ç»„ä»¶ï¼Œå³ç»™æ¨¡æ¿ä½¿ç”¨åˆ°çš„æ¯ä¸€ä¸ªå±æ€§ç»‘å®šç›‘å¬ï¼Œ è€Œreactæ˜¯é‡‡ç”¨è‡ªé¡¶è€Œä¸‹çš„æ›´æ–°ç­–ç•¥ï¼Œæ¯æ¬¡å°çš„æ”¹åŠ¨éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„vdomã€‚

> åœ¨ä¸å¸¦keyçš„æƒ…å†µä¸‹ï¼Œå¯¹äºç®€å•åˆ—è¡¨é¡µæ¸²æŸ“æ¥è¯´ï¼Œå°±åœ°å¤ç”¨ï¼ŒdiffèŠ‚ç‚¹æ›´å¿«æ˜¯æ²¡æœ‰é”™è¯¯çš„ã€‚ä½†æ˜¯è¿™å¹¶ä¸æ˜¯keyçš„ä½œç”¨å‘€

**keyæ˜¯ç»™æ¯ä¸€ä¸ªvnodeçš„å”¯ä¸€id,å¯ä»¥ä¾é key,æ›´å‡†ç¡®, æ›´å¿«çš„æ‹¿åˆ°oldVnodeä¸­å¯¹åº”çš„vnodeèŠ‚ç‚¹** ï¼š

- æ›´å‡†ç¡®ï¼š å¸¦keyå°±ä¸æ˜¯å°±åœ°å¤ç”¨äº†ï¼Œåœ¨sameNodeå‡½æ•° a.key === b.keyå¯¹æ¯”ä¸­å¯ä»¥é¿å…å°±åœ°å¤ç”¨çš„æƒ…å†µã€‚æ‰€ä»¥ä¼šæ›´åŠ å‡†ç¡®
- æ›´å¿«ï¼š åˆ©ç”¨keyçš„å”¯ä¸€æ€§ç”Ÿæˆmapå¯¹è±¡æ¥è·å–å¯¹åº”èŠ‚ç‚¹ï¼Œæ¯”éå†æ–¹å¼æ›´å¿«

```js
// vueé¡¹ç›®  src/core/vdom/patch.js  -488è¡Œ
// ä»¥ä¸‹æ˜¯ä¸ºäº†é˜…è¯»æ€§è¿›è¡Œæ ¼å¼åŒ–åçš„ä»£ç 

// oldCh æ˜¯ä¸€ä¸ªæ—§è™šæ‹ŸèŠ‚ç‚¹æ•°ç»„
if (isUndef(oldKeyToIdx)) {
  oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx)
}
if(isDef(newStartVnode.key)) {
  // map æ–¹å¼è·å–
  idxInOld = oldKeyToIdx[newStartVnode.key]
} else {
  // éå†æ–¹å¼è·å–
  idxInOld = findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx)
}

// åˆ›å»º map

function createKeyToOldIdx (children, beginIdx, endIdx) {
  let i, key
  const map = {}
  for (i = beginIdx; i <= endIdx; ++i) {
    key = children[i].key
    if (isDef(key)) map[key] = i
  }
  return map
}

// éå†å¯»æ‰¾

// sameVnode æ˜¯å¯¹æ¯”æ–°æ—§èŠ‚ç‚¹æ˜¯å¦ç›¸åŒçš„å‡½æ•°
 function findIdxInOld (node, oldCh, start, end) {
    for (let i = start; i < end; i++) {
      const c = oldCh[i]
      if (isDef(c) && sameVnode(node, c)) return i
    }
  }
```

### æ³¨æ„

- keyä¸æ˜¯ç”¨æ¥æå‡reactçš„æ€§èƒ½çš„ï¼Œä¸è¿‡ç”¨å¥½keyå¯¹æ€§èƒ½æ˜¯æœ‰å¸®ç»„çš„ã€‚
- ä¸èƒ½ä½¿ç”¨randomæ¥ä½¿ç”¨key
- keyç›¸åŒï¼Œè‹¥ç»„ä»¶å±æ€§æœ‰æ‰€å˜åŒ–ï¼Œåˆ™reactåªæ›´æ–°ç»„ä»¶å¯¹åº”çš„å±æ€§ï¼›æ²¡æœ‰å˜åŒ–åˆ™ä¸æ›´æ–°ã€‚
- keyå€¼ä¸åŒï¼Œåˆ™reactå…ˆé”€æ¯è¯¥ç»„ä»¶(æœ‰çŠ¶æ€ç»„ä»¶çš„componentWillUnmountä¼šæ‰§è¡Œ)ï¼Œç„¶åé‡æ–°åˆ›å»ºè¯¥ç»„ä»¶ï¼ˆæœ‰çŠ¶æ€ç»„ä»¶çš„constructorå’ŒcomponentWillUnmountéƒ½ä¼šæ‰§è¡Œï¼‰
