# TCP相关

> TCP协议链接

❓ TCP 三次握手和四次挥手的理解

## 优解 🚀

- [https://juejin.im/post/5c078058f265da611c26c235](https://juejin.im/post/5c078058f265da611c26c235)
- [TCP协议相关问题](https://juejin.cn/post/6844904070889603085?utm_source=gold_browser_extension%3Futm_source%3Dgold_browser_extension)

![TCP链接](./TCP.png)

由于TCP连接是全双工的，因此每个方向都必须单独进行关闭，所以即使没有最后一个包，也需要先回复断开连接的请求，然后再发送关闭请求
对于发送端和接收端而言，TCP 需要把发送的数据放到发送缓存区, 将接收的数据放到接收缓存区。
而流量控制索要做的事情，就是在通过接收缓存区的大小，控制发送端的发送。如果对方的接收缓存区满了，就不能再继续发送了。

TCP 滑动窗口分为两种: 发送窗口和接收窗口。

### TCP 和 UDP

`TCP` 是一个面向连接的、可靠的、基于字节流的传输层协议
`UDP` 是一个面向无连接的传输层协议

- **面向连接**：指的是客户端和服务器的连接，在双方互相通信之前，TCP 需要三次握手建立连接，而 UDP 没有相应建立连接的过程。
- **可靠性**: TCP 花了非常多的功夫保证连接的可靠。状态可靠，连接可控。UDP 就是无状态, 不可控的
  - TCP 会精准记录哪些数据发送了，哪些数据被对方接收了，哪些没有被接收到，而且保证数据包按序到达，不允许半点差错。这是有状态。
  - 当意识到丢包了或者网络环境不佳，TCP 会根据具体情况调整自己的行为，控制自己的发送速度或者重发。这是可控制。
- **面向字节流**: UDP 的数据传输是基于数据报的，这是因为仅仅只是继承了 IP 层的特性，而 TCP 为了维护状态，将一个个 IP 包变成了字节流。

### 三次握手

> 三次握手（Three-way Handshake）其实就是指建立一个TCP连接时，需要客户端和服务器总共发送3个包

**主要作用**就是为了确认双方的接收能力和发送能力是否正常、指定自己的初始化序列号为后面的可靠性传送做准备
**实质**其实就是连接服务器指定端口，建立TCP连接，并同步连接双方的序列号和确认号，交换TCP窗口大小信息

- 第一次：客户端 ——> 问询SYN报文 ——> 服务端 （确认客户端有发送能力）
- 第二次：服务端 ——> 应答SYN报文 ——> 客户端 （服务端拥有了发送、接受能力）
- 第三次：客户端 ——> ACK报文 ——> 服务端 （确认客户端有了接受能力）
- 建立连接状态

第三次握手的时候，是可以携带数据的。但是，第一次、第二次握手不可以携带数据

### 四次挥手

> 终止一个连接要经过四次挥手, 这由TCP的半关闭（half-close）造成的。所谓的半关闭，其实就是TCP提供了连接的一端在结束它的发送后还能接收来自另一端数据的能力。

- 第一次：客户端 ——> FIN报文 ——> 服务端 （客户端要关闭了）
- 第二次：服务端 ——> ACK报文 ——> 客户端 （服务端知道了客户端要关闭）
- 第三次：服务端 ——> FIN报文 ——> 客户端 （处理完所有报文，服务端通知客户端，可以关闭了）
- 第四次：客户端 ——> ACK报文 ——> 服务端 （客服端我关闭了）

