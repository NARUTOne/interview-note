# httpç¼“å­˜

> http çš„æ•´ä½“ç¼“å­˜æµç¨‹

â“ ç®€å•è®²è§£ä¸€ä¸‹ HTTP çš„ç¼“å­˜æœºåˆ¶

## ä¼˜è§£ ğŸš€

HTTP ç¼“å­˜åˆ†ä¸º 2 ç§ï¼Œä¸€ç§æ˜¯å¼ºç¼“å­˜ï¼Œå¦ä¸€ç§æ˜¯åå•†ç¼“å­˜ã€‚ä¸»è¦ä½œç”¨æ˜¯å¯ä»¥åŠ å¿«èµ„æºè·å–é€Ÿåº¦ï¼Œæå‡ç”¨æˆ·ä½“éªŒï¼Œå‡å°‘ç½‘ç»œä¼ è¾“ï¼Œç¼“è§£æœåŠ¡ç«¯çš„å‹åŠ›ã€‚

![http-cache](./imgs/http-cache.png)

### å¼ºç¼“å­˜

ä¸éœ€è¦å‘é€è¯·æ±‚åˆ°æœåŠ¡ç«¯ï¼Œç›´æ¥è¯»å–æµè§ˆå™¨æœ¬åœ°ç¼“å­˜ï¼Œåœ¨ Chrome çš„ Network ä¸­æ˜¾ç¤ºçš„ HTTP çŠ¶æ€ç æ˜¯ 200 ï¼Œåœ¨ Chrome ä¸­ï¼Œå¼ºç¼“å­˜åˆåˆ†ä¸º `Disk Cache` (å­˜æ”¾åœ¨ç¡¬ç›˜ä¸­)å’Œ `Memory Cache` (å­˜æ”¾åœ¨å†…å­˜ä¸­)ï¼Œå­˜æ”¾çš„ä½ç½®æ˜¯ç”±æµè§ˆå™¨æ§åˆ¶çš„ã€‚æ˜¯å¦å¼ºç¼“å­˜ç”± `Expires`ã€`Cache-Control` å’Œ `Pragma` 3 ä¸ª Header å±æ€§å…±åŒæ¥æ§åˆ¶ã€‚

**Expires**: HTTPç¼“å­˜æ—¥æœŸæ§åˆ¶ï¼Œæ ¹æ®ç³»ç»Ÿæ—¶é—´å’Œ Expires çš„å€¼è¿›è¡Œæ¯”è¾ƒ

å½“ç³»ç»Ÿæ—¶é—´å’ŒæœåŠ¡å™¨æ—¶é—´ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œä¼šæœ‰ç¼“å­˜æœ‰æ•ˆæœŸä¸å‡†çš„é—®é¢˜ã€‚Expires çš„ä¼˜å…ˆçº§åœ¨ä¸‰ä¸ª Header å±æ€§ä¸­æ˜¯æœ€ä½çš„ã€‚

**Cache-Control**ï¼šHTTP/1.1 ä¸­æ–°å¢çš„å±æ€§ï¼Œåœ¨è¯·æ±‚å¤´å’Œå“åº”å¤´ä¸­éƒ½å¯ä»¥ä½¿ç”¨

- `max-age`ï¼šå•ä½æ˜¯ç§’ï¼Œç¼“å­˜æ—¶é—´è®¡ç®—çš„æ–¹å¼æ˜¯è·ç¦»å‘èµ·çš„æ—¶é—´çš„ç§’æ•°ï¼Œè¶…è¿‡é—´éš”çš„ç§’æ•°ç¼“å­˜å¤±æ•ˆ
- `no-cache`ï¼šä¸ä½¿ç”¨å¼ºç¼“å­˜ï¼Œéœ€è¦ä¸æœåŠ¡å™¨éªŒè¯ç¼“å­˜æ˜¯å¦æ–°é²œ
- `no-store`ï¼šç¦æ­¢ä½¿ç”¨ç¼“å­˜ï¼ˆåŒ…æ‹¬åå•†ç¼“å­˜ï¼‰ï¼Œæ¯æ¬¡éƒ½å‘æœåŠ¡å™¨è¯·æ±‚æœ€æ–°çš„èµ„æº
- `private`ï¼šä¸“ç”¨äºä¸ªäººçš„ç¼“å­˜ï¼Œä¸­é—´ä»£ç†ã€CDN ç­‰ä¸èƒ½ç¼“å­˜æ­¤å“åº”
- `public`ï¼šå“åº”å¯ä»¥è¢«ä¸­é—´ä»£ç†ã€CDN ç­‰ç¼“å­˜
- `must-revalidate`ï¼šåœ¨ç¼“å­˜è¿‡æœŸå‰å¯ä»¥ä½¿ç”¨ï¼Œè¿‡æœŸåå¿…é¡»å‘æœåŠ¡å™¨éªŒè¯

**Pragma**: Pragma åªæœ‰ä¸€ä¸ªå±æ€§å€¼ï¼Œå°±æ˜¯ no-cache ï¼Œæ•ˆæœå’Œ Cache-Control ä¸­çš„ no-cache ä¸€è‡´ï¼Œ

ä¸ä½¿ç”¨å¼ºç¼“å­˜ï¼Œéœ€è¦ä¸æœåŠ¡å™¨éªŒè¯ç¼“å­˜æ˜¯å¦æ–°é²œï¼Œåœ¨ 3 ä¸ªå¤´éƒ¨å±æ€§ä¸­çš„ä¼˜å…ˆçº§æœ€é«˜
å½“ Pragma å’Œ Cache-Control åŒæ—¶å­˜åœ¨çš„æ—¶å€™ï¼ŒPragma çš„ä¼˜å…ˆçº§é«˜äº Cache-Controlã€‚

```js
const express = require('express');
const app = express();
var options = { 
  etag: false, // ç¦ç”¨åå•†ç¼“å­˜
  lastModified: false, // ç¦ç”¨åå•†ç¼“å­˜
  setHeaders: (res, path, stat) => {
    res.set('Cache-Control', 'max-age=10'); // å¼ºç¼“å­˜è¶…æ—¶æ—¶é—´ä¸º10ç§’
  },
};
app.use(express.static((__dirname + '/public'), options));
app.listen(3000);

```

### åå•†ç¼“å­˜

å½“æµè§ˆå™¨çš„å¼ºç¼“å­˜å¤±æ•ˆçš„æ—¶å€™æˆ–è€…è¯·æ±‚å¤´ä¸­è®¾ç½®äº†ä¸èµ°å¼ºç¼“å­˜ï¼Œå¹¶ä¸”åœ¨è¯·æ±‚å¤´ä¸­è®¾ç½®äº†`If-Modified-Since` æˆ–è€… `If-None-Match` çš„æ—¶å€™ï¼Œä¼šå°†è¿™ä¸¤ä¸ªå±æ€§å€¼åˆ°æœåŠ¡ç«¯å»éªŒè¯æ˜¯å¦å‘½ä¸­åå•†ç¼“å­˜ï¼Œå¦‚æœå‘½ä¸­äº†åå•†ç¼“å­˜ï¼Œä¼šè¿”å› 304 çŠ¶æ€ï¼ŒåŠ è½½æµè§ˆå™¨ç¼“å­˜ï¼Œå¹¶ä¸”å“åº”å¤´ä¼šè®¾ç½® `Last-Modified` æˆ–è€… `ETag` å±æ€§ã€‚

**ETag/If-None-Match**: æ˜¯ä¸€ä¸² hash ç ï¼Œä»£è¡¨çš„æ˜¯ä¸€ä¸ªèµ„æºçš„æ ‡è¯†ç¬¦ï¼Œå½“æœåŠ¡ç«¯çš„æ–‡ä»¶å˜åŒ–çš„æ—¶å€™ï¼Œå®ƒçš„ hashç ä¼šéšä¹‹æ”¹å˜.

é€šè¿‡è¯·æ±‚å¤´ä¸­çš„ If-None-Match å’Œå½“å‰æ–‡ä»¶çš„ hash å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰åˆ™è¡¨ç¤ºå‘½ä¸­åå•†ç¼“å­˜ã€‚ETag åˆæœ‰å¼ºå¼±æ ¡éªŒä¹‹åˆ†ï¼Œå¦‚æœ hash ç æ˜¯ä»¥ "W/" å¼€å¤´çš„ä¸€ä¸²å­—ç¬¦ä¸²ï¼Œè¯´æ˜æ­¤æ—¶åå•†ç¼“å­˜çš„æ ¡éªŒæ˜¯å¼±æ ¡éªŒçš„ï¼Œåªæœ‰æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶å·®å¼‚ï¼ˆæ ¹æ® ETag è®¡ç®—æ–¹å¼æ¥å†³å®šï¼‰è¾¾åˆ°èƒ½å¤Ÿè§¦å‘ hash å€¼åç¼€å˜åŒ–çš„æ—¶å€™ï¼Œæ‰ä¼šçœŸæ­£åœ°è¯·æ±‚èµ„æºï¼Œå¦åˆ™è¿”å› 304 å¹¶åŠ è½½æµè§ˆå™¨ç¼“å­˜ã€‚

**Last-Modified/If-Modified-Since**: ä»£è¡¨çš„æ˜¯æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´

ç¬¬ä¸€æ¬¡è¯·æ±‚æœåŠ¡ç«¯ä¼šæŠŠèµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´æ”¾åˆ° Last-Modified å“åº”å¤´ä¸­ï¼Œç¬¬äºŒæ¬¡å‘èµ·è¯·æ±‚çš„æ—¶å€™ï¼Œè¯·æ±‚å¤´ä¼šå¸¦ä¸Šä¸Šä¸€æ¬¡å“åº”å¤´ä¸­çš„ Last-Modified çš„æ—¶é—´ï¼Œå¹¶æ”¾åˆ° If-Modified-Since è¯·æ±‚å¤´å±æ€§ä¸­ï¼ŒæœåŠ¡ç«¯æ ¹æ®æ–‡ä»¶æœ€åä¸€æ¬¡ä¿®æ”¹æ—¶é—´å’Œ If-Modified-Since çš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ï¼Œè¿”å› 304 ï¼Œå¹¶åŠ è½½æµè§ˆå™¨ç¼“å­˜ã€‚

```js
const express = require('express');
const app = express();
var options = { 
  etag: true, // å¼€å¯åå•†ç¼“å­˜
  lastModified: true, // å¼€å¯åå•†ç¼“å­˜
  setHeaders: (res, path, stat) => {
    res.set({
      'Cache-Control': 'max-age=00', // æµè§ˆå™¨ä¸èµ°å¼ºç¼“å­˜
      'Pragma': 'no-cache', // æµè§ˆå™¨ä¸èµ°å¼ºç¼“å­˜
    });
  },
};
app.use(express.static((__dirname + '/public'), options));
app.listen(3001);

```

ä¸ºäº†ä¿è¯ lastModified ä¸å½±å“ç¼“å­˜ï¼Œé€šè¿‡ Last-Modified/If-Modified-Since è¯·æ±‚å¤´åˆ é™¤äº†

```js
const express = require('express');
const CryptoJS = require('crypto-js/crypto-js');
const fs = require('fs');
const app = express();
var options = { 
  etag: true, // åªé€šè¿‡Etagæ¥åˆ¤æ–­
  lastModified: false, // å…³é—­å¦ä¸€ç§åå•†ç¼“å­˜
  setHeaders: (res, path, stat) => {
    const data = fs.readFileSync(path, 'utf-8'); // è¯»å–æ–‡ä»¶
    const hash = CryptoJS.MD5((JSON.stringify(data))); // MD5åŠ å¯†
    res.set({
      'Cache-Control': 'max-age=00', // æµè§ˆå™¨ä¸èµ°å¼ºç¼“å­˜
      'Pragma': 'no-cache', // æµè§ˆå™¨ä¸èµ°å¼ºç¼“å­˜
      'ETag': hash, // æ‰‹åŠ¨è®¾ç½®Etagå€¼ä¸ºMD5åŠ å¯†åçš„hashå€¼
    });
  },
};
app.use(express.static((__dirname + '/public'), options));
app.listen(4000); // ä½¿ç”¨æ–°ç«¯å£å·ï¼Œå¦åˆ™ä¸Šé¢éªŒè¯çš„åå•†ç¼“å­˜ä¼šä¸€ç›´å­˜åœ¨

```
