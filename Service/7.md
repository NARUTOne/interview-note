# 浏览器相关问题2

> 浏览器工作原理篇的查缺补漏

**⚡题目**: 🔥

1、为什么JavaScript是单线程的，与异步冲突吗❓

🚀 不冲突

***

> JS中其实是没有线程概念的，所谓的单线程也只是相对于多线程而言。JS的设计初衷就没有考虑这些，针对JS这种不具备并行任务处理的特性，我们称之为“单线程”

**JS的单线程**是指一个浏览器进程中只有一个JS的执行线程，同一时刻内只会有一段代码在执行: 不能又操作DOM，又删除DOM。

**异步机制**是浏览器的两个或以上常驻线程共同完成的：JS执行线程和事件触发线程。

- JS执行线程发起异步请求（浏览器会开启一个HTTP请求线程来执行请求，这时JS的任务完成，继续执行线程队列中剩下任务）
- 然后在未来的某一时刻事件触发线程监视到之前的发起的HTTP请求已完成，它就会把完成事件插入到JS执行队列的尾部等待JS处理

**定时器触发(settimeout和setinterval)**：浏览器的定时器线程执行的定时计数，然后在定时时间把定时处理函数的执行请求插入到JS执行队列的尾端，所有执行时间不准确。

2、CSS加载会造成阻塞吗❓

🚀

- CSS不会阻塞DOM解析，但会阻塞DOM渲染。
- CSS会阻塞JS执行，并不会阻塞JS文件下载

***

CSSOM作用：

- 第一个是提供给 JavaScript 操作样式表的能力
- 第二个是为布局树的合成提供基础的样式信息
- 这个 CSSOM 体现在 DOM 中就是`document.styleSheets`

DOM 和 CSSOM通常是并行构建的，所以`CSS 加载不会阻塞 DOM 的解析`。
然而由于Render Tree 是依赖DOM Tree和 CSSOM Tree的，所以它必须等到两者都加载完毕后，完成相应的构建，才开始渲染，因此，`CSS加载会阻塞DOM渲染`。
JavaScript 是可操纵 DOM 的，为了防止渲染出现不可预期的结果,浏览器设置`GUI 渲染线程与 JavaScript 引擎为互斥`的关系。

有时候JS需要等到CSS的下载，这是为什么呢？

为避免样式获取，因而只好等前面所有的样式下载完后，再执行JS。
JS文件下载和CSS文件下载是并行的，有时候CSS文件很大，所以JS需要等待。
因此,样式表会在后面的 js 执行前先加载执行完毕,所以 `css 会阻塞后面 js 的执行`

3、为什么JS会阻塞页面加载❓

🚀 JS阻塞DOM解析，也就会阻塞页面

当 JavaScript 引擎执行时 GUI 线程会被挂起，GUI 渲染线程会被保存在一个队列中,直到 JS 程序执行完成,才会接着执行，时间过长，会导致页面渲染阻塞

4、defer 和 async 的区别 ❓

🚀 如果 JavaScript 文件中没有操作 DOM 相关代码，就可以将该 JavaScript 脚本设置为异步加载，通过 async 或 defer 来标记代码

- 两者都是异步去加载外部JS文件，不会阻塞DOM解析
- `Async`是在外部JS加载完成后，浏览器空闲时，`Load`事件触发前执行，标记为async的脚本并不保证按照指定他们的先后顺序执行，该属性对于内联脚本无作用 (即没有「src」属性的脚本）。
- `defer`是在JS加载完成后，整个文档解析完成后，触发 `DOMContentLoaded` 事件前执行，如果缺少 src 属性（即内嵌脚本），该属性不应被使用，因为这种情况下它不起作用

5、DOMContentLoaded 与 load 的区别 ❓

🚀 DOMContentLoaded -> load

- DOMContentLoaded事件触发时：仅当DOM解析完成后，不包括样式表，图片等资源。
- onload 事件触发时,页面上所有的 DOM,样式表,脚本,图片等资源已经加载完毕
- 带async的脚本一定会在load事件之前执行，可能会在DOMContentLoaded之前或之后执行。
- 如果 script 标签中包含 defer，那么这一块脚本将不会影响 HTML 文档的解析，而是等到HTML 解析完成后才会执行。而 DOMContentLoaded 只有在 defer 脚本执行结束后才会被触发。

6、为什么CSS动画一般比JavaScript高效 ❓

🚀 尽可能的避免重排和重绘

- 使用createDocumentFragment进行批量的 DOM 操作
- 对于 resize、scroll 等进行防抖/节流处理。
- rAF(requestAnimationFrame)优化, rAF 的执行步伐跟着系统的绘制频率走, 不会丢帧，卡顿。

`window.requestAnimationFrame()` 方法告诉浏览器您希望执行动画并请求浏览器在下一次重绘之前调用指定的函数来更新动画。该方法使用一个回调函数作为参数，这个回调函数会在浏览器重绘之前调用

7、XSS攻击、CSRF攻击 ❓

🚀

- XSS 全称是 Cross Site Scripting 跨站（域）脚本
- CSRF 英文全称是 Cross-site request forgery 跨站请求伪造

***

`XSS`是指黑客往 HTML 文件中或者 DOM 中注入恶意脚本，从而在用户浏览页面时利用注入的恶意脚本对用户实施攻击的一种手段。

完成某些目的：

- 窃取Cookie
- 监听用户行为，比如输入账号密码后之间发给黑客服务器
- 在网页中生成浮窗广告
- 修改DOM伪造登入表单

实现方式：

- 存储型 XSS 攻击：利用漏洞将恶意代码存到数据库 -》 请求页面，执行恶意脚本 -》 获取用户信息，上传到黑客本地数据库
- 反射型 XSS 攻击：恶意脚本作为网络请求的一部分，用户页面中执行
- 基于 DOM 的 XSS 攻击：黑客通过各种手段将恶意脚本注入用户的页面中，在数据传输的时候劫持网络数据包

阻止策略：

- 对输入脚本进行过滤或转码，防止注入脚本执行，尤其是类似于`<script>、<img>、<a>`标签
- CSP 内容安全策略，服务器决定浏览器加载哪些资源
- HttpOnly保护cookie属性值安全

`CSRF` 攻击就是黑客利用了用户的登录状态，并通过第三方的站点来做一些坏事。

模拟一些网站，误导用户进入

实现方式：

- 利用`<img>`src属性植入链接，去自动请求get接口
- 自动发起form登录提交的post请求
- 引诱用户点击链接

策略：

- 验证来源站点
- 利用Cookie的SameSite属性
- 使用token令牌
