# P41

> localStorage

**âš¡é¢˜ç›®**:

â“ æ¨¡æ‹Ÿå®ç°ä¸€ä¸ª localStorage

## ä¼˜è§£ ğŸ”¥

1ã€`same-origin rules` ç‰¹å®šäºé¡µé¢çš„åè®®ï¼Œè¿˜æœ‰éšèº«æ¨¡å¼çš„åŒºåˆ«
å½“æµè§ˆå™¨è¿›å…¥éšèº«æ¨¡å¼(private browsing mode)çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ã€ä¸´æ—¶çš„ã€ç©ºçš„æ•°æ®åº“ï¼Œç”¨ä»¥å­˜å‚¨æœ¬åœ°æ•°æ®(local storage data)ã€‚å½“æµè§ˆå™¨å…³é—­æ—¶ï¼Œé‡Œé¢çš„æ‰€æœ‰æ•°æ®éƒ½å°†è¢«ä¸¢å¼ƒã€‚

2ã€æ¨¡æ‹ŸæŒä¹…å­˜å‚¨

- a. like Internet Explorer < 8. It also makes use of cookies.
- b. IndexedDB
- c. WebSQL

3ã€Storage Interface

```js
interface Storage {
  readonly attribute unsigned long length;
  [IndexGetter] DOMString key(in unsigned long index);
  [NameGetter] DOMString getItem(in DOMString key);
  [NameSetter] void setItem(in DOMString key, in DOMString data);
  [NameDeleter] void removeItem(in DOMString key);
  void clear();
};
```

4ã€localStorage ä¸­çš„é”®å€¼å¯¹æ€»æ˜¯ä»¥å­—ç¬¦ä¸²çš„å½¢å¼å­˜å‚¨ `key.toString() value.toString()`

```js
localStorage.setItem('a', {a:1})
undefined

localStorage.getItem('a')
"[object Object]"

a={a:1}
localStorage.setItem(a, {a:1})
{[object Object]: "[object Object]"}

localStorage.setItem('a', document.body)
localStorage.getItem('a')
"[object HTMLBodyElement]"
```

> cookie å®ç°ï¼›é™¤äº†å®ç°apiï¼Œè¿˜å¾—è€ƒè™‘æ•°æ®å­˜å‚¨æŒç»­æ€§

[MDN LocalStorage å…¼å®¹](https://developer.mozilla.org/zh-CN/docs/Web/API/Storage/LocalStorage)

```js
!window.localStorage && !function(win) {
  var thousandYears = 1e3 * 365 * 24 * 36e5;

  function getCookies() {
    return document.cookie.match(/([^;=]+)=([^;]+)/g) || [];
  }

  function getExpires(flag) {
    flag = flag || 1;

    return 'expires=' +
      (new Date((+new Date()) + thousandYears * flag)).toUTCString();
  }

  function get(key) {
    var cookies = getCookies();

    for (var i = 0; i < cookies.length; i++) {
      var param = cookies[i].match(/^\s*([^=]+)=(.+)/);

      if (param[1] === String(key)) {
        return decodeURIComponent(param[2]);
      }
    }

    return null;
  }

  function set(key, value, isExpired) {
    document.cookie = [
      key + '=' + encodeURIComponent(value),
      getExpires(isExpired ? -1 : 1),
      'path=/'
    ].join('; ');
  }

  function remove(key) {
    set(key, '', true);
  }

  function clear() {
    var cookies = getCookies();

    for (var i = 0; i < cookies.length; i++) {
      var key = cookies[i].match(/^\s*([^=]+)/)[1];
      remove(key);
    }
  }

  // æ³¨å†Œåˆ° window å¯¹è±¡ä¸Š
  win.localStorage = {
    getItem: get,
    setItem: set,
    removeItem: remove,
    clear: clear
  };
}(window);

localStorage.setItem('key', 'value', new Date() + 10000) // 10 ç§’é’Ÿåè¿‡æœŸ
localStorage.getItem('key')
```
