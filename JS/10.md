# P10

> JS ä¸­ new æ“ä½œç¬¦

**âš¡é¢˜ç›®**:

â“ å®ç°ä¸€ä¸ª new æ“ä½œç¬¦

## ä¼˜è§£ ğŸ”¥

> å‚è€ƒ [æ¨¡æ‹Ÿå®ç°JSçš„newæ“ä½œç¬¦](https://juejin.im/post/5bde7c926fb9a049f66b8b52#heading-6)

- åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡
- æŠŠæ–°å¯¹è±¡çš„åŸå‹æŒ‡å‘æ„é€ å‡½æ•°çš„prototype
- æŠŠæ„é€ å‡½æ•°é‡Œçš„thisæŒ‡å‘æ–°å¯¹è±¡
- è¿”å›è¿™ä¸ªæ–°å¯¹è±¡

```js
// ç¤ºä¾‹
function constructorFunction(name, age){
  this.name = name;
  this.age = age;
}
constructorFunction.prototype.say = function(){
  return 'Hello '+ this.name
}

var obj = new constructorFunction('willian', 18)
console.log(obj.name, obj.age);//'willian', 18
console.log(obj.say())//Hello willian
```

> æ¨¡æ‹Ÿ new

```js
/**
 * æ¨¡æ‹Ÿå®ç° new æ“ä½œç¬¦
 * @param  {Function} ctor [æ„é€ å‡½æ•°]
 * @return {Object|Function|Regex|Date|Error}      [è¿”å›ç»“æœ]
 */
function newOperator(ctor){
    if(typeof ctor !== 'function'){
      throw 'newOperator function the first param must be a function';
    }
    // ES6 new.target æ˜¯æŒ‡å‘æ„é€ å‡½æ•°
    newOperator.target = ctor;
    // 1.åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ï¼Œ
    // 2.å¹¶ä¸”æ‰§è¡Œ[[Prototype]]é“¾æ¥
    // 4.é€šè¿‡`new`åˆ›å»ºçš„æ¯ä¸ªå¯¹è±¡å°†æœ€ç»ˆè¢«`[[Prototype]]`é“¾æ¥åˆ°è¿™ä¸ªå‡½æ•°çš„`prototype`å¯¹è±¡ä¸Šã€‚
    var newObj = Object.create(ctor.prototype);
    // ES5 argumentsè½¬æˆæ•°ç»„ å½“ç„¶ä¹Ÿå¯ä»¥ç”¨ES6 [...arguments], Aarry.from(arguments);
    // é™¤å»ctoræ„é€ å‡½æ•°çš„å…¶ä½™å‚æ•°
    var argsArr = [].slice.call(arguments, 1);
    // 3.ç”Ÿæˆçš„æ–°å¯¹è±¡ä¼šç»‘å®šåˆ°å‡½æ•°è°ƒç”¨çš„`this`ã€‚
    // è·å–åˆ°ctorå‡½æ•°è¿”å›ç»“æœ
    var ctorReturnResult = ctor.apply(newObj, argsArr);
    // å°ç»“4 ä¸­è¿™äº›ç±»å‹ä¸­åˆå¹¶èµ·æ¥åªæœ‰Objectå’ŒFunctionä¸¤ç§ç±»å‹ typeof null ä¹Ÿæ˜¯'object'æ‰€ä»¥è¦ä¸ç­‰äºnullï¼Œæ’é™¤null
    var isObject = typeof ctorReturnResult === 'object' && ctorReturnResult !== null;
    var isFunction = typeof ctorReturnResult === 'function';
    if(isObject || isFunction){
        return ctorReturnResult;
    }
    // 5.å¦‚æœå‡½æ•°æ²¡æœ‰è¿”å›å¯¹è±¡ç±»å‹`Object`(åŒ…å«`Functoin`, `Array`, `Date`, `RegExg`, `Error`)ï¼Œé‚£ä¹ˆ`new`è¡¨è¾¾å¼ä¸­çš„å‡½æ•°è°ƒç”¨ä¼šè‡ªåŠ¨è¿”å›è¿™ä¸ªæ–°çš„å¯¹è±¡ã€‚
    return newObj;
}

```
