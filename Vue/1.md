# P1

> Vue ä¸­çš„ åŒå‘æ•°æ®ç»‘å®š

**âš¡é¢˜ç›®**:

â“ èŠèŠ Vue çš„åŒå‘æ•°æ®ç»‘å®šï¼ŒModel å¦‚ä½•æ”¹å˜ Viewï¼ŒView åˆæ˜¯å¦‚ä½•æ”¹å˜ Model çš„ï¼Ÿ

## ä¼˜è§£ ğŸ”¥

![v-model](./imgs/v-model.jpg)

- ä» M åˆ° V çš„æ˜ å°„ï¼ˆData Bindingï¼‰ï¼Œè¿™æ ·å¯ä»¥å¤§é‡èŠ‚çœä½ äººè‚‰æ¥ update View çš„ä»£ç 
- ä» V åˆ° M çš„äº‹ä»¶ç›‘å¬ï¼ˆDOM Listenersï¼‰ï¼Œè¿™æ ·ä½ çš„ Model ä¼šéšç€ View è§¦å‘äº‹ä»¶è€Œæ”¹å˜

[v-model è‡ªå®šä¹‰ç»„ä»¶ç»“åˆ](https://juejin.im/post/5c77c53051882523f0267e18)

```html
<currency-input v-model="price"></currentcy-input>
<!--ä¸Šè¡Œä»£ç æ˜¯ä¸‹è¡Œçš„è¯­æ³•ç³–
  <currency-input :value="price" @input="price = arguments[0]"></currency-input>
-->
```

ç»™ç»„ä»¶æ·»åŠ  v-model å±æ€§æ—¶ï¼Œé»˜è®¤ä¼šæŠŠ value ä½œä¸ºç»„ä»¶çš„å±æ€§ï¼Œç„¶åæŠŠ 'input' å€¼ä½œä¸ºç»™ç»„ä»¶ç»‘å®šäº‹ä»¶æ—¶çš„äº‹ä»¶å

**Vue2.x**æ—¶ä»£

`Object.definedProperty`

```html
<input type="text" id='inp'>
<div id='view'></div>
<script>
    const input = document.getElementById('inp');
    const view = document.getElementById('view');

    let data = {
        // name: 'view'
        valueObj:{
            name:'view'
        }
    }

    function update() { //æ›´æ–°è§†å›¾
        view.innerText = data.valueObj.name;
    }

    input.oninput = function () { //æ›´æ–°æ•°æ®
        data.valueObj.name = this.value
    }

    function observerData(obj) {
        if (!obj || typeof obj != 'object') return obj; //å®¹é”™ + é€’å½’å‡ºå£

        Object.keys(obj).forEach(key => {
            definedRective(obj, key, obj[key]);
        })
    }

    observerData(data);

    function definedRective(obj, key, val) {

        observerData(val); //æ·±å±‚æ•°æ®é€’å½’å¤„ç†

        Object.defineProperty(obj, key, {
            get() {
                return val;
            },
            set(newVal) {
                if (val === newVal) return; //ä¼˜åŒ–æ€§èƒ½
                val = newVal;
                update();
            }
        })
    }
</script>
```

- ä¸èƒ½ç›´æ¥ç›‘æ§æ•°ç»„ï¼Œè€Œæ˜¯é—´æ¥é‡å†™Array.prototypeä¸Šçš„æ•°ç»„æ–¹æ³•(å°±æ˜¯vueä¸­å¸¸å¸¸å¬è§çš„æ•°ç»„å˜å¼‚æ–¹æ³•)æ¯”å¦‚pushã€unshfit...å±æ€§,ç›‘å¬æ•°ç»„åŸå‹ä¸Šçš„è¿™äº›æ–¹æ³•,è¿›è€Œå®ç°æ›´æ–°
- å¦‚æœè¢«ç›‘å¬å¯¹è±¡åœ¨æ‰§è¡Œç›‘å¬ä¹‹ååˆé‡æ–°æ·»åŠ äº†å±æ€§,è¿™äº›å±æ€§å€¼åˆ™æ— æ³•ç›‘å¬åˆ°

**Vue3.x**å±•æœ›

`Proxy&Reflect`

```js
let oProxy = new Proxy(data, {
    get(target, key, receiver) {
        console.log(1)
        return Reflect.get(target, key);
    },
    set(target, key, newValue, receiver) {
        console.log(1)
        return Reflect.set(target, key, newValue)
    }
});
```

## è§‚å¯Ÿè€…æ¨¡å¼

- `observerï¼ˆç›‘å¬å™¨ï¼‰`ï¼šæ³¨æ„ï¼Œæ­¤ observer éå½¼ observerã€‚åœ¨æˆ‘ä»¬ä¸ŠèŠ‚çš„è§£æä¸­ï¼Œobserver ä½œä¸ºè®¾è®¡æ¨¡å¼ä¸­çš„ä¸€ä¸ªè§’è‰²ï¼Œä»£è¡¨â€œè®¢é˜…è€…â€ã€‚ä½†åœ¨Vueæ•°æ®åŒå‘ç»‘å®šçš„è§’è‰²ç»“æ„é‡Œï¼Œæ‰€è°“çš„ observer ä¸ä»…æ˜¯ä¸€ä¸ªæ•°æ®ç›‘å¬å™¨ï¼Œå®ƒè¿˜éœ€è¦å¯¹ç›‘å¬åˆ°çš„æ•°æ®è¿›è¡Œè½¬å‘â€”â€”ä¹Ÿå°±æ˜¯è¯´å®ƒåŒæ—¶è¿˜æ˜¯ä¸€ä¸ªå‘å¸ƒè€…ã€‚
- `watcherï¼ˆè®¢é˜…è€…ï¼‰`ï¼šobserver æŠŠæ•°æ®è½¬å‘ç»™äº†çœŸæ­£çš„è®¢é˜…è€…â€”â€”watcherå¯¹è±¡ã€‚watcher æ¥æ”¶åˆ°æ–°çš„æ•°æ®åï¼Œä¼šå»æ›´æ–°è§†å›¾ã€‚
- `compileï¼ˆç¼–è¯‘å™¨ï¼‰`ï¼šMVVM æ¡†æ¶ç‰¹æœ‰çš„è§’è‰²ï¼Œè´Ÿè´£å¯¹æ¯ä¸ªèŠ‚ç‚¹å…ƒç´ æŒ‡ä»¤è¿›è¡Œæ‰«æå’Œè§£æï¼ŒæŒ‡ä»¤çš„æ•°æ®åˆå§‹åŒ–ã€è®¢é˜…è€…çš„åˆ›å»ºè¿™äº›â€œæ‚æ´»â€ä¹Ÿå½’å®ƒç®¡~

```js
// observeæ–¹æ³•éå†å¹¶åŒ…è£…å¯¹è±¡å±æ€§
function observe(target) {
    // è‹¥targetæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™éå†å®ƒ
    if(target && typeof target === 'object') {
        Object.keys(target).forEach((key)=> {
            // defineReactiveæ–¹æ³•ä¼šç»™ç›®æ ‡å±æ€§è£…ä¸Šâ€œç›‘å¬å™¨â€
            defineReactive(target, key, target[key])
        })
    }
}

// å®šä¹‰defineReactiveæ–¹æ³•
function defineReactive(target, key, val) {
    const dep = new Dep()
    // å±æ€§å€¼ä¹Ÿå¯èƒ½æ˜¯objectç±»å‹ï¼Œè¿™ç§æƒ…å†µä¸‹éœ€è¦è°ƒç”¨observeè¿›è¡Œé€’å½’éå†
    observe(val)
    // ä¸ºå½“å‰å±æ€§å®‰è£…ç›‘å¬å™¨
    Object.defineProperty(target, key, {
         // å¯æšä¸¾
        enumerable: true,
        // ä¸å¯é…ç½®
        configurable: false,
        get: function () {
            return val;
        },
        // ç›‘å¬å™¨å‡½æ•°
        set: function (value) {
            console.log(`${target}å±æ€§çš„${key}å±æ€§ä»${val}å€¼å˜æˆäº†äº†${value}`)
            val = value
            // é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…
            dep.notify()
        }
    });
}

// å®šä¹‰è®¢é˜…è€…ç±»Dep
class Dep {
    constructor() {
        // åˆå§‹åŒ–è®¢é˜…é˜Ÿåˆ—
        this.subs = []
    }

    // å¢åŠ è®¢é˜…è€…
    addSub(sub) {
        this.subs.push(sub)
    }

    // é€šçŸ¥è®¢é˜…è€…ï¼ˆæ˜¯ä¸æ˜¯æ‰€æœ‰çš„ä»£ç éƒ½ä¼¼æ›¾ç›¸è¯†ï¼Ÿï¼‰
    notify() {
        this.subs.forEach((sub)=>{
            sub.update()
        })
    }
}
```
