# å“åº”å¼

> Vue2ã€Vue3

**âš¡é¢˜ç›®**:

â“ Vueæ•°æ®å“åº”å¼ç®€å•å®ç°

## ä¼˜è§£ ğŸ”¥

Vueæ™®éèµ°çš„å°±æ˜¯æ•°æ®åŠ«æŒæ–¹å¼ã€‚ä¸åŒçš„åœ¨äºä½¿ç”¨`DefineProperty`è¿˜æ˜¯`Proxy`ã€‚ä¹Ÿå°±æ˜¯ä¸€æ¬¡ä¸€ä¸ªå±æ€§åŠ«æŒè¿˜æ˜¯ä¸€æ¬¡åŠ«æŒä¸€ä¸ªå¯¹è±¡ã€‚å½“ç„¶åè€…æ¯”å‰è€…å¬ç€å°±æ˜æ˜¾æœ‰ä¼˜åŠ¿ã€‚è¿™ä¹Ÿå°±æ˜¯`Vue3`çš„å“åº”å¼åŸç†ã€‚

ä¼˜åŠ¿åœ¨äºï¼š

- é’ˆå¯¹æ•´ä¸ªå¯¹è±¡å®šåˆ¶ è€Œä¸æ˜¯å¯¹è±¡çš„æŸä¸ªå±æ€§ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸éœ€è¦å¯¹keysè¿›è¡Œéå†ã€‚
- æ”¯æŒæ•°ç»„,è¿™ä¸ª`DefineProperty`ä¸å…·å¤‡ã€‚è¿™æ ·å°±çœå»äº†é‡è½½æ•°ç»„æ–¹æ³•è¿™æ ·çš„Hackè¿‡ç¨‹ã€‚
- `Proxy` çš„ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥æœ‰ 13 ç§æ‹¦æˆªæ–¹æ³•ï¼Œè¿™æ¯”èµ· `Object.defineProperty()` è¦æ›´åŠ ä¸°å¯Œ
- `Proxy` ä½œä¸ºæ–°æ ‡å‡†å—åˆ°æµè§ˆå™¨å‚å•†çš„é‡ç‚¹å…³æ³¨å’Œæ€§èƒ½ä¼˜åŒ–ï¼Œç›¸æ¯”ä¹‹ä¸‹ `Object.defineProperty()` æ˜¯ä¸€ä¸ªå·²æœ‰çš„è€æ–¹æ³•
- å¯ä»¥é€šè¿‡é€’å½’æ–¹ä¾¿çš„è¿›è¡Œå¯¹è±¡åµŒå¥—ã€‚

### DefineProperty

`Vue2`çš„å®ç°æ–¹å¼æ˜¯é€šè¿‡`Object.defineProperty`æ¥é‡æ–°å®šä¹‰`getter`ï¼Œ`setter`æ–¹æ³•å®ç°çš„

```js
// å‰¯ä½œç”¨
let effective
function effect(fun) {
  effective = fun
}

// æ•°ç»„å¤„ç†
const oldArrayPrototype = Array.prototype
const proto = Object.create(oldArrayPrototype);

['push','pop','shift','unshift','splice','sort','reverse'].forEach(method => {
  // api å‡½æ•°åŠ«æŒ
  proto[method] = function(){
    effective()
    oldArrayPrototype[method].call(this,...arguments)
  }
})

// å“åº”å¼
function reactive(data) {
  if (typeof data !== 'object' || data === null) {
    return data
  }

  // æ•°ç»„é€šè¿‡æ•°æ®åŠ«æŒæä¾›å“åº”å¼
  if(Array.isArray(data)){
      data.__proto__ = proto
  }

  // éå†å±æ€§
  Object.keys(data).forEach(function (key) {
    let value = data[key];
    // é€’å½’è°ƒç”¨ï¼Œæ·±åº¦éå†
    reactive(value)

    // åŠ«æŒ
    Object.defineProperty(data, key, {
      emumerable: false,
      configurable: true,
      get: () => {
        return value
      },
      set: newVal => {
        if (newVal !== value) {
          effective()
          value = newVal
        }
      }
    })
  })
  return data
}

module.exports = {
  effect, reactive
}

```

### Proxy

`Proxy/Reflect`æ˜¯åœ¨ES2015è§„èŒƒä¸­åŠ å…¥çš„ï¼Œ`Proxy`å¯ä»¥æ›´å¥½çš„æ‹¦æˆªå¯¹è±¡è¡Œä¸ºï¼Œ`Reflect`å¯ä»¥æ›´ä¼˜é›…çš„æ“çºµå¯¹è±¡

```js
let effective;
function effect(fun) {
  effective = fun;
}

function reactive(data) {
  if (typeof data !== 'object' || data === null) {
      return data
  }
  const observed = new Proxy(data, {
    get(target, key, receiver) {
      // Reflectæœ‰è¿”å›å€¼ä¸æŠ¥é”™
      let result = Reflect.get(target, key, receiver)

      // é€’å½’ å¤šå±‚ä»£ç†
      return typeof result !== 'object' ? result : reactive(result) 
    },
    set(target, key, value, receiver) {
      effective()
      // proxy + reflect
      const ret = Reflect.set(target, key, value, receiver)
      return ret
    },

    deleteProperty(target,key){
      const ret = Reflect.deleteProperty(target,key)
      return ret
    }
  })
  return observed
}

module.exports = {
  reactive,
  effect,
};
```
