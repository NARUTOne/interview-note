# å“åº”å¼

> Vue2 `DefineProperty` ã€Vue3 `Proxy`

**âš¡é¢˜ç›®**:

â“ Vueæ•°æ®å“åº”å¼ç®€å•å®ç°

## ä¼˜è§£ ğŸ”¥

Vueæ™®éèµ°çš„å°±æ˜¯æ•°æ®åŠ«æŒæ–¹å¼ã€‚ä¸åŒçš„åœ¨äºä½¿ç”¨`DefineProperty`è¿˜æ˜¯`Proxy`ã€‚ä¹Ÿå°±æ˜¯ä¸€æ¬¡ä¸€ä¸ªå±æ€§åŠ«æŒè¿˜æ˜¯ä¸€æ¬¡åŠ«æŒä¸€ä¸ªå¯¹è±¡ã€‚å½“ç„¶åè€…æ¯”å‰è€…å¬ç€å°±æ˜æ˜¾æœ‰ä¼˜åŠ¿ã€‚è¿™ä¹Ÿå°±æ˜¯`Vue3`çš„å“åº”å¼åŸç†ã€‚

ä¼˜åŠ¿åœ¨äºï¼š

- `DefineProperty`å¯¹äºes6ä¸­æ–°äº§ç”Ÿçš„Mapã€Setè¿™äº›æ•°æ®ç»“æ„ä¸æ”¯æŒ
- é’ˆå¯¹æ•´ä¸ªå¯¹è±¡å®šåˆ¶ è€Œä¸æ˜¯å¯¹è±¡çš„æŸä¸ªå±æ€§ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸éœ€è¦å¯¹keysè¿›è¡Œéå†ã€‚`DefineProperty` æ–°å¢æˆ–åˆ é™¤å±æ€§æ—¶éœ€è¦ç”¨æˆ·ä½¿ç”¨Vue.set/deleteè¿™æ ·ç‰¹æ®Šçš„apiæ‰èƒ½ç”Ÿæ•ˆ
- æ”¯æŒæ•°ç»„,è¿™ä¸ª`DefineProperty`ä¸å…·å¤‡ã€‚è¿™æ ·å°±çœå»äº†é‡è½½æ•°ç»„æ–¹æ³•è¿™æ ·çš„Hackè¿‡ç¨‹ã€‚
- `Proxy` çš„ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥æœ‰ 13 ç§æ‹¦æˆªæ–¹æ³•ï¼Œè¿™æ¯”èµ· `Object.defineProperty()` è¦æ›´åŠ ä¸°å¯Œ
- `Proxy` ä½œä¸ºæ–°æ ‡å‡†å—åˆ°æµè§ˆå™¨å‚å•†çš„é‡ç‚¹å…³æ³¨å’Œæ€§èƒ½ä¼˜åŒ–ï¼Œç›¸æ¯”ä¹‹ä¸‹ `Object.defineProperty()` æ˜¯ä¸€ä¸ªå·²æœ‰çš„è€æ–¹æ³•
- å¯ä»¥é€šè¿‡é€’å½’æ–¹ä¾¿çš„è¿›è¡Œå¯¹è±¡åµŒå¥—ã€‚

### DefineProperty

`Vue2`çš„å®ç°æ–¹å¼é‡‡ç”¨æ•°æ®åŠ«æŒç»“åˆ`å‘å¸ƒè€…-è®¢é˜…è€…æ¨¡å¼`çš„æ–¹å¼ï¼Œé€šè¿‡`Object.defineProperty()`æ¥åŠ«æŒå„ä¸ªå±æ€§çš„`setter`å’Œ`getter`ï¼Œåœ¨æ•°æ®å˜åŠ¨æ—¶å‘å¸ƒæ¶ˆæ¯ç»™è®¢é˜…è€…ï¼Œè§¦å‘ç›¸åº”çš„ç›‘å¬å›è°ƒ

å“åº”å¼çš„æ•°æ®åˆ†ä¸ºä¸¤ç±»ï¼š

**å¯¹è±¡**ï¼Œå¾ªç¯éå†å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œä¸ºæ¯ä¸ªå±æ€§è®¾ç½® getterã€setterï¼Œä»¥è¾¾åˆ°æ‹¦æˆªè®¿é—®å’Œè®¾ç½®çš„ç›®çš„ï¼Œå¦‚æœå±æ€§å€¼ä¾æ—§ä¸ºå¯¹è±¡ï¼Œåˆ™é€’å½’ä¸ºå±æ€§å€¼ä¸Šçš„æ¯ä¸ª key è®¾ç½® getterã€setter

- è®¿é—®æ•°æ®æ—¶ï¼ˆobj.key)è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œåœ¨ dep ä¸­å­˜å‚¨ç›¸å…³çš„ watcher
- è®¾ç½®æ•°æ®æ—¶ç”± dep é€šçŸ¥ç›¸å…³çš„ watcher å»æ›´æ–°

**æ•°ç»„**ï¼Œå¢å¼ºæ•°ç»„çš„é‚£ 7 ä¸ªå¯ä»¥æ›´æ”¹è‡ªèº«çš„åŸå‹æ–¹æ³•ï¼Œç„¶åæ‹¦æˆªå¯¹è¿™äº›æ–¹æ³•çš„æ“ä½œ

- æ·»åŠ æ–°æ•°æ®æ—¶è¿›è¡Œå“åº”å¼å¤„ç†ï¼Œç„¶åç”± dep é€šçŸ¥ watcher å»æ›´æ–°
- åˆ é™¤æ•°æ®æ—¶ï¼Œä¹Ÿè¦ç”± dep é€šçŸ¥ watcher å»æ›´æ–°

æ ¸å¿ƒæ¨¡å—ï¼š

1. `Observer`ï¼šèƒ½å¤Ÿå¯¹æ•°æ®å¯¹è±¡çš„æ‰€æœ‰å±æ€§è¿›è¡Œç›‘å¬ï¼Œå¦‚æœ‰å˜åŠ¨å¯æ‹¿åˆ°æœ€æ–°å€¼å¹¶é€šçŸ¥è®¢é˜…è€….
é€šè¿‡Object.defineProprtty()æ¥ç›‘å¬æ•°æ®çš„å˜åŠ¨ï¼Œè¿™ä¸ªå‡½æ•°å†…éƒ¨å¯ä»¥å®šä¹‰setterå’Œgetterï¼Œæ¯å½“æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šè§¦å‘setterã€‚è¿™æ—¶å€™Observerå°±è¦é€šçŸ¥è®¢é˜…è€…ï¼Œè®¢é˜…è€…å°±æ˜¯Watcher

2. `Compile`ï¼šå¯¹æ¯ä¸ªå…ƒç´ èŠ‚ç‚¹çš„æŒ‡ä»¤è¿›è¡Œæ‰«æå’Œè§£æï¼Œæ ¹æ®æŒ‡ä»¤æ¨¡æ¿æ›¿æ¢æ•°æ®ï¼Œä»¥åŠç»‘å®šç›¸åº”çš„æ›´æ–°å‡½æ•°ã€‚
ä¸»è¦åšçš„äº‹æƒ…æ˜¯è§£ææ¨¡æ¿æŒ‡ä»¤ï¼Œå°†æ¨¡æ¿ä¸­å˜é‡æ›¿æ¢æˆæ•°æ®ï¼Œç„¶ååˆå§‹åŒ–æ¸²æŸ“é¡µé¢è§†å›¾ï¼Œå¹¶å°†æ¯ä¸ªæŒ‡ä»¤å¯¹åº”çš„èŠ‚ç‚¹ç»‘å®šæ›´æ–°å‡½æ•°ï¼Œæ·»åŠ é‰´å®šæ•°æ®çš„è®¢é˜…è€…ï¼Œä¸€æ—¦æ•°æ®æœ‰å˜åŠ¨ï¼Œæ”¶åˆ°é€šçŸ¥ï¼Œæ›´æ–°è¯•å›¾

3. `Watcher`ï¼šé“¾æ¥Observerå’ŒCompileçš„æ¡¥æ¢ï¼Œèƒ½å¤Ÿè®¢é˜…å¹¶æ”¶åˆ°æ¯ä¸ªå±æ€§å˜åŠ¨çš„é€šçŸ¥ï¼Œæ‰§è¡ŒæŒ‡ä»¤ç»‘å®šçš„ç›¸åº”çš„å›è°ƒå‡½æ•°ï¼Œä»è€Œæ›´æ–°è¯•å›¾ã€‚

ä¸»è¦åšçš„äº‹æƒ…æ˜¯ï¼š

- åœ¨è‡ªèº«å®ä¾‹åŒ–æ—¶å¾€å±æ€§è®¢é˜…å™¨(dep)é‡Œé¢æ·»åŠ è‡ªå·±
- è‡ªèº«å¿…é¡»æœ‰ä¸€ä¸ªupdate()æ–¹æ³•
- å¾…å±æ€§å˜åŠ¨`dep.notice()`é€šçŸ¥æ—¶ï¼Œèƒ½è°ƒç”¨è‡ªèº«çš„`update()`æ–¹æ³•ï¼Œå¹¶`è§¦å‘Compileä¸­ç»‘å®šçš„å›è°ƒ`

```js
// å‰¯ä½œç”¨
let effective
function effect(fun) {
  effective = fun
}

// æ•°ç»„å¤„ç†
const oldArrayPrototype = Array.prototype
const proto = Object.create(oldArrayPrototype);

['push','pop','shift','unshift','splice','sort','reverse'].forEach(method => {
  // api å‡½æ•°åŠ«æŒ
  proto[method] = function(){
    effective()
    oldArrayPrototype[method].call(this,...arguments)
  }
})

// å“åº”å¼
function reactive(data) {
  if (typeof data !== 'object' || data === null) {
    return data
  }

  // æ•°ç»„é€šè¿‡æ•°æ®åŠ«æŒæä¾›å“åº”å¼
  if(Array.isArray(data)){
      data.__proto__ = proto
  }

  // éå†å±æ€§
  Object.keys(data).forEach(function (key) {
    let value = data[key];
    // é€’å½’è°ƒç”¨ï¼Œæ·±åº¦éå†
    reactive(value)

    // åŠ«æŒ
    Object.defineProperty(data, key, {
      emumerable: false,
      configurable: true,
      get: () => {
        return value
      },
      set: newVal => {
        if (newVal !== value) {
          effective()
          value = newVal
        }
      }
    })
  })
  return data
}

module.exports = {
  effect, reactive
}

```

### Proxy

`Proxy/Reflect`æ˜¯åœ¨ES2015è§„èŒƒä¸­åŠ å…¥çš„ï¼Œ`Proxy`å¯ä»¥æ›´å¥½çš„æ‹¦æˆªå¯¹è±¡è¡Œä¸ºï¼Œ`Reflect`å¯ä»¥æ›´ä¼˜é›…çš„æ“çºµå¯¹è±¡

```js
let effective;
function effect(fun) {
  effective = fun;
}

function reactive(data) {
  if (typeof data !== 'object' || data === null) {
      return data
  }
  const observed = new Proxy(data, {
    get(target, key, receiver) {
      // Reflectæœ‰è¿”å›å€¼ä¸æŠ¥é”™
      let result = Reflect.get(target, key, receiver)

      // é€’å½’ å¤šå±‚ä»£ç†
      return typeof result !== 'object' ? result : reactive(result) 
    },
    set(target, key, value, receiver) {
      effective()
      // proxy + reflect
      const ret = Reflect.set(target, key, value, receiver)
      return ret
    },

    deleteProperty(target,key){
      const ret = Reflect.deleteProperty(target,key)
      return ret
    }
  })
  return observed
}

module.exports = {
  reactive,
  effect,
};
```

### methodsã€computed å’Œ watch æœ‰ä»€ä¹ˆåŒºåˆ«

**ä½¿ç”¨åœºæ™¯**ï¼š

- methods ä¸€èˆ¬ç”¨äºå°è£…ä¸€äº›è¾ƒä¸ºå¤æ‚çš„å¤„ç†é€»è¾‘ï¼ˆåŒæ­¥ã€å¼‚æ­¥ï¼‰
- computed ä¸€èˆ¬ç”¨äºå°è£…ä¸€äº›ç®€å•çš„åŒæ­¥é€»è¾‘ï¼Œå°†ç»è¿‡å¤„ç†çš„æ•°æ®è¿”å›ï¼Œç„¶åæ˜¾ç¤ºåœ¨æ¨¡ç‰ˆä¸­ï¼Œä»¥å‡è½»æ¨¡ç‰ˆçš„é‡é‡
- watch ä¸€èˆ¬ç”¨äºå½“éœ€è¦åœ¨æ•°æ®å˜åŒ–æ—¶æ‰§è¡Œå¼‚æ­¥æˆ–å¼€é”€è¾ƒå¤§çš„æ“ä½œ

**åŒºåˆ«**ï¼š

- methods VS computed

é€šè¿‡ç¤ºä¾‹ä¼šå‘ç°ï¼Œå¦‚æœåœ¨ä¸€æ¬¡æ¸²æŸ“ä¸­ï¼Œæœ‰å¤šä¸ªåœ°æ–¹ä½¿ç”¨äº†åŒä¸€ä¸ª methods æˆ– computed å±æ€§ï¼Œmethods ä¼šè¢«æ‰§è¡Œå¤šæ¬¡ï¼Œè€Œ computed çš„å›è°ƒå‡½æ•°åˆ™åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ã€‚
é€šè¿‡é˜…è¯»æºç æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ä¸€æ¬¡æ¸²æŸ“ä¸­ï¼Œå¤šæ¬¡è®¿é—® computedPropertyï¼Œåªä¼šåœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œ computed å±æ€§çš„å›è°ƒå‡½æ•°ï¼Œåç»­çš„å…¶å®ƒè®¿é—®ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ç¬¬ä¸€æ¬¡çš„æ‰§è¡Œç»“æœï¼ˆwatcher.valueï¼‰ï¼Œè€Œè¿™ä¸€åˆ‡çš„å®ç°åŸç†åˆ™æ˜¯é€šè¿‡å¯¹ watcher.dirty å±æ€§çš„æ§åˆ¶å®ç°çš„ã€‚è€Œ methodsï¼Œæ¯ä¸€æ¬¡çš„è®¿é—®åˆ™æ˜¯ç®€å•çš„æ–¹æ³•è°ƒç”¨ï¼ˆthis.xxMethodsï¼‰ã€‚

- computed VS watch

é€šè¿‡é˜…è¯»æºç æˆ‘ä»¬çŸ¥é“ï¼Œcomputed å’Œ watch çš„æœ¬è´¨æ˜¯ä¸€æ ·çš„ï¼Œå†…éƒ¨éƒ½æ˜¯é€šè¿‡ Watcher æ¥å®ç°çš„ï¼Œå…¶å®æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œéè¦è¯´åŒºåˆ«çš„åŒ–å°±ä¸¤ç‚¹ï¼š1ã€ä½¿ç”¨åœºæ™¯ä¸Šçš„åŒºåˆ«ï¼Œ2ã€computed é»˜è®¤æ˜¯æ‡’æ‰§è¡Œçš„ï¼Œåˆ‡ä¸å¯æ›´æ”¹ã€‚

- methods VS watch

methods å’Œ watch ä¹‹é—´å…¶å®æ²¡ä»€ä¹ˆå¯æ¯”çš„ï¼Œå®Œå…¨æ˜¯ä¸¤ä¸ªä¸œè¥¿ï¼Œä¸è¿‡åœ¨ä½¿ç”¨ä¸Šå¯ä»¥æŠŠ watch ä¸­ä¸€äº›é€»è¾‘æŠ½åˆ° methods ä¸­ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§ã€‚
