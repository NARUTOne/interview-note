# P3

> Vue nextTickå®ç°

**âš¡é¢˜ç›®**:

â“ å¦‚ä½•å®ç° nextTickå‘¢ï¼Ÿ

## ä¼˜è§£ ğŸ”¥

[è°ˆä¸€è°ˆ nextTick çš„åŸç†](https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/281#issuecomment-532025481)

> é¦–å…ˆå¯ä»¥æƒ³åˆ°çš„æ˜¯åˆ©ç”¨ setTimeout çš„å¼‚æ­¥å›è°ƒæ¥å®ç°ï¼Œä¸è¿‡ç”±äºå„ä¸ªæµè§ˆå™¨çš„ä¸åŒï¼ŒsetTimeout çš„å»¶è¿Ÿå¾ˆé«˜ï¼Œå› æ­¤åœ¨ nextTick ä¸­åªä½œä¸ºæœ€åçš„å¤‡èƒï¼Œé¦–é€‰çš„æ–¹æ¡ˆåˆ™æ˜¯ MutationObserver

- [MutationObserver MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver)
- [MutationObserver è¿ç”¨](https://juejin.im/post/5c26d01a6fb9a049b07d6ce2)

```js
// å½“å‰ä¸ºv1.0.9ç‰ˆæœ¬, V2.xç”±äº es6 çš„æ–°è¯­æ³•ï¼ŒnextTick å¼€å§‹ä½¿ç”¨ Promise.then å’Œ MO æ¥åšé¦–é€‰å’Œæ¬¡é€‰ï¼Œåœ¨å‰é¢çš„è®¨è®ºä¸­å·²ç»æåˆ°ï¼ŒPromise.then ä¹Ÿå±äº microtaskã€‚
export const nextTick = (function () {
  var callbacks = []
  var pending = false
  var timerFunc
  function nextTickHandler () {
    pending = false
    var copies = callbacks.slice(0)
    callbacks = []
    for (var i = 0; i < copies.length; i++) {
      copies[i]()
    }
  }
  /* istanbul ignore if */
  if (typeof MutationObserver !== 'undefined') { // é¦–é€‰ MutationObserver 
    var counter = 1
    var observer = new MutationObserver(nextTickHandler) // å£°æ˜ MO å’Œå›è°ƒå‡½æ•°
    var textNode = document.createTextNode(counter)
    observer.observe(textNode, { // ç›‘å¬ textNode è¿™ä¸ªæ–‡æœ¬èŠ‚ç‚¹
      characterData: true // ä¸€æ—¦æ–‡æœ¬æ”¹å˜åˆ™è§¦å‘å›è°ƒå‡½æ•° nextTickHandler
    })
    timerFunc = function () {
      counter = (counter + 1) % 2 // æ¯æ¬¡æ‰§è¡Œ timeFunc éƒ½ä¼šè®©æ–‡æœ¬åœ¨ 1 å’Œ 0 é—´åˆ‡æ¢
      textNode.data = counter
    }
  } else {
    timerFunc = setTimeout // å¦‚æœä¸æ”¯æŒ MutationObserver, é€€é€‰ setTimeout
  }
  return function (cb, ctx) {
    var func = ctx
      ? function () { cb.call(ctx) }
      : cb
    callbacks.push(func)
    if (pending) return
    pending = true
    timerFunc(nextTickHandler, 0)
  }
})()

```
